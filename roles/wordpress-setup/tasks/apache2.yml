---
- name: Copy SSL cert
  copy:
    src: "{{ item.value.ssl.cert }}"
    dest: "{{ apache2_ssl_path }}/{{ item.value.ssl.cert | basename }}"
    mode: 0640
  with_dict: "{{ wordpress_sites }}"
  when: ssl_enabled and item.value.ssl.cert is defined
  notify: reload webserver

- name: Copy SSL key
  copy:
    src: "{{ item.value.ssl.key }}"
    dest: "{{ apache2_ssl_path }}/{{ item.value.ssl.key | basename }}"
    mode: 0600
  with_dict: "{{ wordpress_sites }}"
  when: ssl_enabled and item.value.ssl.key is defined
  notify: reload webserver

- name: Create WordPress configuration for Apache2
  template:
    src: "{{ item.value.apache2_wordpress_site_conf | default(apache2_wordpress_site_conf) }}"
    dest: "{{ apache2_path }}/sites-available/{{ item.key }}.conf"
  with_dict: "{{ wordpress_sites }}"
  notify: reload webserver
  tags: apache2-includes

- name: Enable WordPress site
  file:
    src: "{{ apache2_path }}/sites-available/{{ item.key }}.conf"
    dest: "{{ apache2_path }}/sites-enabled/{{ item.key }}.conf"
    owner: root
    group: root
    state: link
  with_dict: "{{ wordpress_sites }}"
  notify: reload webserver
